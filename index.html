<!DOCTYPE html><html><head><title>Appointment reminders</title><style>body, html {
  height:100%;
  width:100%;
  padding:0;
  margin:0;
  overflow:hidden;
  background-color:#ddd;
}
.wrapper {
  height:100%;
  width:100%;
}</style><link rel="shortcut icon" href="//twilio.com/bundles/marketing/img/favicons/favicon.ico"><link rel="apple-touch-icon" href="//twilio.com/bundles/marketing/img/favicons/favicon_57.png"><link rel="apple-touch-icon" sizes="72x72" href="//twilio.com/bundles/marketing/img/favicons/favicon_72.png"><link rel="apple-touch-icon" sizes="114x114" href="//twilio.com/bundles/marketing/img/favicons/favicon_114.png"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css"><link rel="stylesheet" href="viewsaurus.css"></head><body><div class="wrapper"><div id="viewsaurus" data-title="Appointment reminders"><div class="saurus-panes"><div class="saurus-prose"><div class="saurus-prose-header"><div class="title-outer"><span class="step-title">Appointment reminders</span></div></div><div class="saurus-nav-buttons"><div class="saurus-nav-button nav-overview"><div class="saurus-nav-button-inner"><i class="fa fa-fw fa-list"></i></div><div class="nav-divider"></div></div><div class="saurus-nav-button nav-previous"><div class="saurus-nav-button-inner"><a href=""> <i class="fa fa-fw fa-play fa-rotate-180"></i></a></div><div class="nav-divider"></div></div><div class="saurus-nav-button nav-next clickable"><div class="saurus-nav-button-inner"><a href="#1"> <i class="fa fa-fw fa-play"></i></a></div></div><div class="saurus-next-title"><span class="next-title-inner"></span></div></div><div class="saurus-progress-bar"></div><div class="saurus-start"><p>Learn to implement appointment reminders functionality with Python and Flask</p><a href="#0">Start Tutorial</a></div><div class="saurus-content"><div data-title="The application structure" class="chapter"><div data-file="application.py" data-title="" class="step"><h2 id="what-does-the-application-do-">What does the application do?</h2>
<p>The application allows users to schedule appointment reminders
for customers. The user add a name, a time, a notification time
and phone number and the application will send the customer a
reminder using <a href="https://www.twilio.com/docs/python/install">Twilio\&#39;s
API</a>. The application uses
<a href="http://flask.pocoo.org/">Flask</a> as the underlying web
framework and <a href="http://www.celeryproject.org/">Celery</a> as the task scheduler</p>
<p>Head to the app&#39;s <a href="https://github.com/TwilioDevEd/appointment-reminders-flask/blob/master/readme.md">readme
file</a>
to learn how to run the application in your own computer.</p>
<hr>
<h3 id="other-libraries-used-in-this-app">Other libraries used in this app</h3>
<ul>
<li><a href="http://www.sqlalchemy.org/">SQLAlchemy ORM</a></li>
<li><a href="https://github.com/wtforms/wtforms">WTForms form rendering and validation</a></li>
<li><a href="http://crsmithdev.com/arrow/">Arrow time library</a></li>
<li><a href="https://bitbucket.org/zzzeek/alembic">Alembic migrations</a></li>
<li><a href="http://pytest.org/latest/">pytest to run the tests</a></li>
<li><a href="https://github.com/theskumar/python-dotenv">Dotenv for configuration</a></li>
</ul>
</div><div data-file="application.py" data-highlight="19-58" class="step"><h2 id="the-application-structure">The application structure</h2>
<p>The <code>Application</code> object configures SQLAlchemy, Flask, Twilio
credentials and Celery. The properties of this object are then
used in the rest of the app. The app is configured used
environment variables. The required variables can be found in <code>.env.example</code></p>
<h2 id="setting-environment-variables-using-dotenv-">Setting environment variables using <code>dotenv</code></h2>
<p>Optionally, you can create a <code>.env</code> file containing the
environment variables so you don&#39;t have to set them manually.</p>
</div><div data-file="application.py" data-highlight="51-53" class="step"><h2 id="configuring-the-application">Configuring the application</h2>
<h3 id="configuring-twilio-credentials">Configuring Twilio credentials</h3>
<p>To send messages using Twilio&#39;s API you will need a Twilio
Account SID and a Twilio token. You can find all of these in
your <a href="https://www.twilio.com/user/account/voice">Twilio
dashboard</a>]. You will
also need to configure a Twilio sending number that you can
get/purchase in <a href="https://www.twilio.com/user/account/phone-numbers/incoming">the number management
page</a>. The
variables read from the environment will be stored as part of
Flask&#39;s <code>config</code> dictionary so we can access them later.</p>
<h2 id="other-configuration">Other configuration</h2>
<p>We also need to configure the database (in this case
PostgreSQL), a <a href="http://celery.readthedocs.org/en/latest/getting-started/brokers/">Celery
broker</a>
(in this case Redis) and a secret key Flask will use to encrypt
cookies.</p>
</div><div data-file="views/appointment.py" data-highlight="19-34" class="step"><h2 id="scheduling-appointment-reminders">Scheduling appointment reminders</h2>
<p>When a POST request is submitted to <code>/appointment</code> the
corresponding handler will use WTForms to verify that the
submitted data is valid. If the data is valid we will insert an
appointment row into the database and schedule a job with Celery
to send the reminder. If everything goes according to the plan
the app redirects the user back to the index page. Notice that
this handler only passes the appointment&#39;s ID to the Celery task
that will send the message.</p>
<h2 id="other-handlers">Other handlers</h2>
<p>There are two more handlers implemented within the application:
one to delete existing appointments and one to show an index of
all existing appointments. You can find the source for both of
these in the same file.</p>
<hr>
<h2 id="see-also">See also</h2>
<p><a href="http://celery.readthedocs.org/en/latest/userguide/calling.html#eta-and-countdown">The celery documentation on scheduling
tasks</a></p>
</div><div data-file="tasks.py" class="step"><h2 id="configuring-the-application-to-use-twilio-s-api">Configuring the application to use Twilio&#39;s API</h2>
<p>We have already put all the configuration we need as part of
Flask&#39;s <code>config</code> dictionary. Now we just need read from the
dictionary and initialize Twilio&#39;s REST client. We need to pass
the Twilio Account SID and the Twilio token to the constructor
as keyword arguments. Alternatively, we could let the object
read the variables from the environment.</p>
<h2 id="finding-appointment-details">Finding appointment details</h2>
<p>Since the function to send notifications will be executed by
Celery we need to decorate its definition with Celery&#39;s
generated helpers. This will register the task with Celery. We
want to include some details in the SMS notification so we will
query the database for the appointment&#39;s details before sending
the notification.</p>
<p>If the scheduled task cannot find an appointment with the
scheduled ID then it simply returns doing nothing. This means
the appointment has been deleted and therefore we don&#39;t need to
do anything.</p>
</div><div data-file="tasks.py" data-highlight="27-31" class="step"><h2 id="sending-sms-using-the-api">Sending SMS using the API</h2>
<p>All we need to do now is call the methods in the client
object. We will need to pass a destination phone number, a
sending phone number and the message we want to send. The
library will take it from there</p>
<hr>
<h3 id="see-also">See also</h3>
<ul>
<li><a href="https://twilio-python.readthedocs.org/en/latest/usage/messages.html">Twilio&#39;s documentation on sending messages using
Python</a></li>
</ul>
</div><div data-file="reminders.py" class="step"><h2 id="exposing-celery-s-application-object">Exposing Celery&#39;s application object</h2>
<p>We already configured Celery to use Redis in the first
step, but now we need to expose <a href="http://celery.readthedocs.org/en/latest/userguide/application.html">Celery&#39;s application
object</a>
so we can register tasks against it. It&#39;s also necessary to
expose this object so we can run a Celery worker.</p>
<h2 id="running-the-celery-worker">Running the Celery worker</h2>
<p>Now that we have scheduled tasks we need a worker to run
them. For this application, running the following command in the
root of the application should suffice:</p>
<pre><code>celery -A reminders.celery worker
</code></pre><p>Here <code>reminders</code> is the module containing the already configured
celery object.</p>
</div></div>
<div class="saurus-files" style="display:none;"><textarea class="saurus-file" data-file="application.py" data-mode="python">aW1wb3J0IGZsYXNrCmltcG9ydCBmbGFzay5leHQuc3FsYWxjaGVteQpmcm9tIGNvbmZpZy5kYXRhYmFzZSBpbXBvcnQgRGF0YWJhc2VDb25maWd1cmF0aW9uCmZyb20gY2VsZXJ5IGltcG9ydCBDZWxlcnkKZnJvbSB2aWV3cy5hcHBvaW50bWVudCBpbXBvcnQgQXBwb2ludG1lbnRSZXNvdXJjZURlbGV0ZSwgQXBwb2ludG1lbnRSZXNvdXJjZUNyZWF0ZUluZGV4LCBBcHBvaW50bWVudEZvcm1SZXNvdXJjZQoKY2xhc3MgUm91dGUob2JqZWN0KToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCB1cmwsIHJvdXRlX25hbWUsIHJlc291cmNlKToKICAgICAgICBzZWxmLnVybCA9IHVybAogICAgICAgIHNlbGYucm91dGVfbmFtZSA9IHJvdXRlX25hbWUKICAgICAgICBzZWxmLnJlc291cmNlID0gcmVzb3VyY2UKCmhhbmRsZXJzID0gWwogICAgUm91dGUoJy9hcHBvaW50bWVudCcsICdhcHBvaW50bWVudC5pbmRleCcsIEFwcG9pbnRtZW50UmVzb3VyY2VDcmVhdGVJbmRleCksCiAgICBSb3V0ZSgnL2FwcG9pbnRtZW50LzxpbnQ6aWQ+L2RlbGV0ZScsICdhcHBvaW50bWVudC5kZWxldGUnLCBBcHBvaW50bWVudFJlc291cmNlRGVsZXRlKSwKICAgIFJvdXRlKCcvYXBwb2ludG1lbnQvbmV3JywgJ2FwcG9pbnRtZW50Lm5ldycsIEFwcG9pbnRtZW50Rm9ybVJlc291cmNlKSwKXQoKY2xhc3MgQXBwbGljYXRpb24ob2JqZWN0KToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCByb3V0ZXMsIGNvbmZpZywgZGVidWc9VHJ1ZSk6CiAgICAgICAgc2VsZi5mbGFza19hcHAgPSBmbGFzay5GbGFzayhfX25hbWVfXykKICAgICAgICBzZWxmLnJvdXRlcyA9IHJvdXRlcwogICAgICAgIHNlbGYuZGVidWcgPSBkZWJ1ZwogICAgICAgIHNlbGYuX2NvbmZpZ3VyZV9hcHAoY29uZmlnKQogICAgICAgIHNlbGYuX3NldF9yb3V0ZXMoKQoKICAgIGRlZiBjZWxlcnkoc2VsZik6CiAgICAgICAgYXBwID0gc2VsZi5mbGFza19hcHAKICAgICAgICBjZWxlcnkgPSBDZWxlcnkoYXBwLmltcG9ydF9uYW1lLCBicm9rZXI9YXBwLmNvbmZpZ1snQ0VMRVJZX0JST0tFUl9VUkwnXSkKICAgICAgICBjZWxlcnkuY29uZi51cGRhdGUoYXBwLmNvbmZpZykKCiAgICAgICAgVGFza0Jhc2UgPSBjZWxlcnkuVGFzawogICAgICAgIGNsYXNzIENvbnRleHRUYXNrKFRhc2tCYXNlKToKICAgICAgICAgICAgYWJzdHJhY3QgPSBUcnVlCiAgICAgICAgICAgIGRlZiBfX2NhbGxfXyhzZWxmLCAqYXJncywgKiprd2FyZ3MpOgogICAgICAgICAgICAgICAgd2l0aCBhcHAuYXBwX2NvbnRleHQoKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVGFza0Jhc2UuX19jYWxsX18oc2VsZiwgKmFyZ3MsICoqa3dhcmdzKQogICAgICAgIGNlbGVyeS5UYXNrID0gQ29udGV4dFRhc2sKCiAgICAgICAgcmV0dXJuIGNlbGVyeQoKICAgIGRlZiBfc2V0X3JvdXRlcyhzZWxmKToKICAgICAgICBmb3Igcm91dGUgaW4gc2VsZi5yb3V0ZXM6CiAgICAgICAgICAgIGFwcF92aWV3ID0gcm91dGUucmVzb3VyY2UuYXNfdmlldyhyb3V0ZS5yb3V0ZV9uYW1lKQogICAgICAgICAgICBzZWxmLmZsYXNrX2FwcC5hZGRfdXJsX3J1bGUocm91dGUudXJsLCB2aWV3X2Z1bmM9YXBwX3ZpZXcpCgogICAgZGVmIF9jb25maWd1cmVfYXBwKHNlbGYsIGVudik6CiAgICAgICAgc2VsZi5mbGFza19hcHAuY29uZmlnWydTUUxBTENIRU1ZX0RBVEFCQVNFX1VSSSddID0gZW52LmdldCgnREFUQUJBU0VfVVJJJykKICAgICAgICBzZWxmLmZsYXNrX2FwcC5jb25maWdbJ0NFTEVSWV9CUk9LRVJfVVJMJ10gPSBlbnYuZ2V0KCdDRUxFUllfVVJJJykKICAgICAgICBzZWxmLmZsYXNrX2FwcC5jb25maWdbJ0NFTEVSWV9SRVNVTFRfQkFDS0VORCddID0gZW52LmdldCgnQ0VMRVJZX1VSSScpCiAgICAgICAgc2VsZi5mbGFza19hcHAuY29uZmlnWydUV0lMSU9fQUNDT1VOVF9TSUQnXSA9IGVudi5nZXQoJ1RXSUxJT19BQ0NPVU5UX1NJRCcpCiAgICAgICAgc2VsZi5mbGFza19hcHAuY29uZmlnWydUV0lMSU9fQVVUSF9UT0tFTiddID0gZW52LmdldCgnVFdJTElPX0FVVEhfVE9LRU4nKQogICAgICAgIHNlbGYuZmxhc2tfYXBwLmNvbmZpZ1snVFdJTElPX05VTUJFUiddID0gZW52LmdldCgnVFdJTElPX05VTUJFUicpCiAgICAgICAgc2VsZi5mbGFza19hcHAuc2VjcmV0X2tleSA9IGVudi5nZXQoJ1NFQ1JFVF9LRVknKQogICAgICAgIHNlbGYuZGIgPSBmbGFzay5leHQuc3FsYWxjaGVteS5TUUxBbGNoZW15KHNlbGYuZmxhc2tfYXBwKQoKICAgIGRlZiBzdGFydF9hcHAoc2VsZik6CiAgICAgICAgc2VsZi5mbGFza19hcHAucnVuKGRlYnVnPXNlbGYuZGVidWcpCg==</textarea>
<textarea class="saurus-file" data-file="views/appointment.py" data-mode="python">ZnJvbSBmbGFzay52aWV3cyBpbXBvcnQgTWV0aG9kVmlldwpmcm9tIGZsYXNrIGltcG9ydCByZW5kZXJfdGVtcGxhdGUKZnJvbSBtb2RlbHMuYXBwb2ludG1lbnQgaW1wb3J0IEFwcG9pbnRtZW50CmZyb20gZm9ybXMubmV3X2FwcG9pbnRtZW50IGltcG9ydCBOZXdBcHBvaW50bWVudEZvcm0KZnJvbSBmbGFzayBpbXBvcnQgcmVxdWVzdCwgZmxhc2gsIHJlZGlyZWN0LCB1cmxfZm9yLCBhYm9ydApmcm9tIHNxbGFsY2hlbXkub3JtLmV4YyBpbXBvcnQgTm9SZXN1bHRGb3VuZAppbXBvcnQgcmVtaW5kZXJzCmltcG9ydCBhcnJvdwoKY2xhc3MgQXBwb2ludG1lbnRSZXNvdXJjZURlbGV0ZShNZXRob2RWaWV3KToKICAgIGRlZiBwb3N0KHNlbGYsIGlkKToKICAgICAgICBhcHB0ID0gcmVtaW5kZXJzLmRiLnNlc3Npb24ucXVlcnkoQXBwb2ludG1lbnQpLmZpbHRlcl9ieShpZD1pZCkub25lKCkKICAgICAgICByZW1pbmRlcnMuZGIuc2Vzc2lvbi5kZWxldGUoYXBwdCkKICAgICAgICByZW1pbmRlcnMuZGIuc2Vzc2lvbi5jb21taXQoKQoKICAgICAgICByZXR1cm4gcmVkaXJlY3QodXJsX2ZvcignYXBwb2ludG1lbnQuaW5kZXgnKSwgY29kZT0zMDMpCgpjbGFzcyBBcHBvaW50bWVudFJlc291cmNlQ3JlYXRlSW5kZXgoTWV0aG9kVmlldyk6CiAgICBkZWYgcG9zdChzZWxmKToKICAgICAgICBmb3JtID0gTmV3QXBwb2ludG1lbnRGb3JtKHJlcXVlc3QuZm9ybSkKCiAgICAgICAgaWYgZm9ybS52YWxpZGF0ZSgpOgogICAgICAgICAgICBmcm9tIHRhc2tzIGltcG9ydCBzZW5kX3Ntc19yZW1pbmRlcgoKICAgICAgICAgICAgYXBwdCA9IEFwcG9pbnRtZW50KCoqZm9ybS5kYXRhKQogICAgICAgICAgICBhcHB0LnRpbWUgPSBhcnJvdy5nZXQoYXBwdC50aW1lLCBhcHB0LnRpbWV6b25lKS50bygndXRjJykubmFpdmUKCiAgICAgICAgICAgIHJlbWluZGVycy5kYi5zZXNzaW9uLmFkZChhcHB0KQogICAgICAgICAgICByZW1pbmRlcnMuZGIuc2Vzc2lvbi5jb21taXQoKQogICAgICAgICAgICBzZW5kX3Ntc19yZW1pbmRlci5hcHBseV9hc3luYyhhcmdzPVthcHB0LmlkXSwgZXRhPWFwcHQubm90aWZpY2F0aW9uX3RpbWUoKSkKCiAgICAgICAgICAgIHJldHVybiByZWRpcmVjdCh1cmxfZm9yKCdhcHBvaW50bWVudC5pbmRleCcpLCBjb2RlPTMwMykKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gcmVuZGVyX3RlbXBsYXRlKCdhcHBvaW50bWVudHMvbmV3Lmh0bWwnLCBmb3JtPWZvcm0pLCA0MDAKCiAgICBkZWYgZ2V0KHNlbGYpOgogICAgICAgIGFsbF9hcHBvaW50bWVudHMgPSByZW1pbmRlcnMuZGIuc2Vzc2lvbi5xdWVyeShBcHBvaW50bWVudCkuYWxsKCkKICAgICAgICByZXR1cm4gcmVuZGVyX3RlbXBsYXRlKCdhcHBvaW50bWVudHMvaW5kZXguaHRtbCcsIGFwcG9pbnRtZW50cz1hbGxfYXBwb2ludG1lbnRzKQoKY2xhc3MgQXBwb2ludG1lbnRGb3JtUmVzb3VyY2UoTWV0aG9kVmlldyk6CiAgICBkZWYgZ2V0KHNlbGYpOgogICAgICAgIGZvcm0gPSBOZXdBcHBvaW50bWVudEZvcm0oKQogICAgICAgIHJldHVybiByZW5kZXJfdGVtcGxhdGUoJ2FwcG9pbnRtZW50cy9uZXcuaHRtbCcsIGZvcm09Zm9ybSkK</textarea>
<textarea class="saurus-file" data-file="tasks.py" data-mode="python">ZnJvbSByZW1pbmRlcnMgaW1wb3J0IGNlbGVyeSwgZGIsIGFwcApmcm9tIG1vZGVscy5hcHBvaW50bWVudCBpbXBvcnQgQXBwb2ludG1lbnQKZnJvbSBzcWxhbGNoZW15Lm9ybS5leGMgaW1wb3J0IE5vUmVzdWx0Rm91bmQKZnJvbSB0d2lsaW8ucmVzdCBpbXBvcnQgVHdpbGlvUmVzdENsaWVudApmcm9tIGNlbGVyeS51dGlscy5sb2cgaW1wb3J0IGdldF90YXNrX2xvZ2dlcgppbXBvcnQgYXJyb3cKCnR3aWxpb19hY2NvdW50X3NpZCA9IGFwcC5mbGFza19hcHAuY29uZmlnWydUV0lMSU9fQUNDT1VOVF9TSUQnXQp0d2lsaW9fYXV0aF90b2tlbiA9IGFwcC5mbGFza19hcHAuY29uZmlnWydUV0lMSU9fQVVUSF9UT0tFTiddCnR3aWxpb19udW1iZXIgPSBhcHAuZmxhc2tfYXBwLmNvbmZpZ1snVFdJTElPX05VTUJFUiddCgpjbGllbnQgPSBUd2lsaW9SZXN0Q2xpZW50KGFjY291bnQ9dHdpbGlvX2FjY291bnRfc2lkLCB0b2tlbj10d2lsaW9fYXV0aF90b2tlbikKCkBjZWxlcnkudGFzaygpCmRlZiBzZW5kX3Ntc19yZW1pbmRlcihhcHBvaW50bWVudF9pZCk6CiAgICB0cnk6CiAgICAgICAgYXBwb2ludG1lbnQgPSBkYi5zZXNzaW9uLnF1ZXJ5KEFwcG9pbnRtZW50KS5maWx0ZXJfYnkoaWQ9YXBwb2ludG1lbnRfaWQpLm9uZSgpCiAgICBleGNlcHQgTm9SZXN1bHRGb3VuZDoKICAgICAgICByZXR1cm4KCiAgICB0aW1lID0gYXJyb3cuZ2V0KGFwcG9pbnRtZW50LnRpbWUpLnRvKGFwcG9pbnRtZW50LnRpbWV6b25lKQogICAgYm9keSA9ICJIZWxsbyB7MH0uIFlvdSBoYXZlIGFuIGFwcG9pbnRtZW50IGF0IHsxfSEiLmZvcm1hdCgKICAgICAgICBhcHBvaW50bWVudC5uYW1lLAogICAgICAgIHRpbWUuZm9ybWF0KCdoOm1tIGEnKQogICAgKQoKICAgIG1lc3NhZ2UgPSBjbGllbnQubWVzc2FnZXMuY3JlYXRlKAogICAgICAgICAgICAgICAgYm9keT1ib2R5LAogICAgICAgICAgICAgICAgdG89YXBwb2ludG1lbnQucGhvbmVfbnVtYmVyLAogICAgICAgICAgICAgICAgZnJvbV89dHdpbGlvX251bWJlciwKICAgICkK</textarea>
<textarea class="saurus-file" data-file="reminders.py" data-mode="python">ZnJvbSBhcHBsaWNhdGlvbiBpbXBvcnQgaGFuZGxlcnMsIEFwcGxpY2F0aW9uCmltcG9ydCBvcwoKYXBwID0gQXBwbGljYXRpb24oaGFuZGxlcnMsIG9zLmVudmlyb24sIGRlYnVnPVRydWUpCmRiID0gYXBwLmRiCmNlbGVyeSA9IGFwcC5jZWxlcnkoKQoKaW1wb3J0IHRhc2tzCg==</textarea>
</div>
</div><div class="saurus-overview"><ul></ul></div></div><div class="saurus-code"><div class="file-path"><span class="crumb-container"></span><i class="fa fa-fw fa-folder"></i></div><div class="saurus-editor"></div></div><div class="saurus-explorer"><div class="saurus-file-list"></div><a href="https://github.com/TwilioDevEd/appointment-reminders-flask" target="_blank" class="explorer-get-code"> <i class="fa fa-lg fa-github-square"> </i>View Code on GitHub</a></div></div></div></div><script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script><script src="ace/ace.js"></script><script src="ace/theme-monokai.js"></script><script src="viewsaurus.js"></script></body></html>